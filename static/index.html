<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Business Insights Dashboard</title>
    <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
            rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-light">
<div class="container py-4">
    <h1 class="text-center mb-4">Business Insights Dashboard</h1>

    <div class="card mb-4">
        <div class="card-header">Country-Level Revenue</div>
        <div class="card-body">
            <table class="table table-striped" id="countryTable">
                <thead>
                <tr>
                    <th>Country</th>
                    <th>Product Name</th>
                    <th>Total Revenue</th>
                    <th>Number of Transactions</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div class="d-flex justify-content-between mt-2 mb-4">
        <button id="prevPage" class="btn btn-outline-primary btn-sm">← Previous</button>
        <button id="nextPage" class="btn btn-outline-primary btn-sm">Next →</button>
    </div>


    <div class="card mb-4">
        <div class="card-header">Top 20 Frequently Purchased Products</div>
        <div class="card-body">
            <canvas id="topProductsChart"></canvas>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">Monthly Sales Volume</div>
        <div class="card-body">
            <canvas id="monthlySalesChart"></canvas>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">Top 30 Regions by Revenue</div>
        <div class="card-body">
            <canvas id="topRegionsChart"></canvas>
        </div>
    </div>
</div>

<script>
    let currentPage = 1;
    const limit = 10;

    function loadPage(page) {
        fetch(`/api/revenue-by-country?page=${page}&limit=${limit}`)
            .then(res => res.json())
            .then(data => {
                const tbody = document.querySelector('#countryTable tbody');
                tbody.innerHTML = '';
                data.forEach(row => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${row.country}</td>
                        <td>${row.product_name}</td>
                        <td>$${parseFloat(row.revenue).toFixed(2)}</td>
                        <td>${row.transaction_count}</td>
                    `;
                    tbody.appendChild(tr);
                });
            });
    }

    document.getElementById('prevPage').addEventListener('click', () => {
        if (currentPage > 1) {
            currentPage--;
            loadPage(currentPage);
        }
    });

    document.getElementById('nextPage').addEventListener('click', () => {
        currentPage++;
        loadPage(currentPage);
    });

    loadPage(currentPage);

    fetch('/api/frequent-products?limit=20')
        .then(res => res.json())
        .then(data => {
            new Chart(document.getElementById('topProductsChart'), {
                type: 'bar',
                data: {
                    labels: data.map(d => d.product_name),
                    datasets: [{
                        label: 'Units Sold',
                        data: data.map(d => d.units_sold),
                        backgroundColor: 'rgba(54, 162, 235, 0.6)',
                    }, {
                        label: 'Stock',
                        data: data.map(d => d.available_stock_quantity),
                        backgroundColor: 'rgba(255, 99, 132, 0.6)',
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: { display: true, text: 'Top 20 Products by Frequency & Stock' }
                    }
                }
            });
        });

    fetch('/api/monthly-sales')
        .then(res => res.json())
        .then(data => {
            new Chart(document.getElementById('monthlySalesChart'), {
                type: 'line',
                data: {
                    labels: data.map(d => d.month),
                    datasets: [{
                        label: 'Sales Volume',
                        data: data.map(d => d.total_sales),
                        fill: true,
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: { display: true, text: 'Monthly Sales Volume' }
                    }
                }
            });
        });

    fetch('/api/revenue-by-region?limit=30')
        .then(res => res.json())
        .then(data => {
            new Chart(document.getElementById('topRegionsChart'), {
                type: 'bar',
                data: {
                    labels: data.map(d => d.region),
                    datasets: [{
                        label: 'Revenue ($)',
                        data: data.map(d => d.revenue),
                        backgroundColor: 'rgba(153, 102, 255, 0.6)'
                    }]
                },
                options: {
                    responsive: true,
                    indexAxis: 'y',
                    plugins: {
                        title: { display: true, text: 'Top 30 Regions by Revenue' }
                    }
                }
            });
        });
</script>
</body>
</html>
